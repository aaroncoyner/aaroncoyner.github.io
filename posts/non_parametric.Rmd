---
title: 'Tutorial: Non-Parametric Tests'
author: 'Created by Aaron Coyner'
date: "2018-09-19"
tags: ['R', 'Statistics']
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(error = TRUE, comment = NA, warning = FALSE, message = FALSE, tidy = FALSE, echo = TRUE)
```


### Acknowledgements
This tutorial was adapted from [Amber Lin's](https://ohsu-psu-sph.org/faculty-directory/name/amber-lin/) tutorials for PHPM 524: Introduction to Biostatistics at Oregon Health & Science University.

# Overview
This tutorial provides an introduction to non-parametric tests.

**Data Set 1:**  "These data appeared in a paper which reported the carbon monoxide transfer factor levels in seven smokers with chicken pox with a view to determining their risk of contracting pneumonia. The measurements were taken on entry to hospital and one week after admission. The main question is straightforward: has the carbon monoxide transfer factor changed significantly over one week?" (In A Handbook of Small Data Sets by Hand et al [1994], Data Set #284: Pneumonia risk in smokers with chicken pox, page 228)

**Data Set 2:** "Lebranchu et al (A-4) conducted a study in which the subjects were nine patients with common variable immunodeficiency (CVI) and 12 normal controls. Among the data collected were the following on number of CD4+ T-cells per $mm^3$ of peripheral blood. May we conclude, on the basis of these data, CVI patients have a reduced level of CD4+ cells?"

**Data Set 3:** "Torr et al. conducted a study to determine serum levels of nitrite in pediatric patients with human immunodeficiency virus type 1 (HIV-1) infection. Subjects included 10 healthy control children (6 boys and 4 girls) with a mean age of 9.7 years and a standard deviation of 3.3. The remainder of the subjects were 21 children born to HIV-1-infected mothers. Of these, seven (3 boys and 4 girls) were affected by AIDS. They had a mean age of 6 years old and a standard deviation of 2.8 years. The remaining 14 children (7 boys and 7 girls) became sero-negative for HIV-1 during the first year of life. Their mean age was 3.3 years with a standard deviation of 2.3 years. Among the data collected were the following serum levels of nitrite ($\mu mol/L$)."


Data sets and Rmarkdown files are available at: https://github.com/coyneras/biostats-tutorials



# Setup

## Install Packages 

Do this once per machine.

```{r install_packages_demo, eval=FALSE}
install.packages('readr')
install.packages('tidyverse')
install.packages('skimr')
```

## Load Packages 

Do this once per R session.

```{r load_packages_demo}
library(readr)
library(tidyverse)
library(skimr)
```

## Import Data 

- Copy the data set .csv files to an easily accessible location
- Use `read_csv()` from the `readr` package to import the .csv files
- The argument supplied to `read_csv()` is the url or path to the dataset
- Finally, assign the data to an R object using `<-` and call that object something simple

```{r}
smoker <- read_csv('data/smoker_pneumonia.csv')
immuno <- read_csv('data/immunodeficiency.csv')
hiv <- read_csv('data/hiv.csv')
```

# Exercise 1

**Data Set 1:**  "These data appeared in a paper which reported the carbon monoxide transfer factor levels in seven smokers with chicken pox with a view to determining their risk of contracting pneumonia. The measurements were taken on entry to hospital and one week after admission. The main question is straightforward: has the carbon monoxide transfer factor changed significantly over one week?" (In A Handbook of Small Data Sets by Hand et al [1994], Data Set #284: Pneumonia risk in smokers with chicken pox, page 228)


## Initial Data Analysis

Use the `head()` function in your console to briefly check the structure of the data set.
```{r head}
head(smoker)
```

`head()` shows us that the data set contains individual observations for each subject per row. Prior to using `skim()` to examine the mean, standard deviation, and quartiles for each variable, we need to drop the `ID` variable since it's not a meaningful variable in this case.

```{r}
smoker %>% 
  select(-ID) %>% 
  skim()
```

Looking at the summary statistics for this data set, namely the mean and standard error for each group, we can see that there does appear to be a difference between means. But we need to show this statistically.


Let’s generate a variable that will be useful for future analyses. We'll compute the difference between `WEEK1` and `BASELINE` and name that variable `DIFF`.
```{r}
smoker = smoker %>%
  mutate(DIFF = WEEK1 - BASELINE)

head(smoker)
```


## Assessing Normality

Now we can look at some other descriptive statistics and plots to really get familiar with the data. The Shapiro-Wilk test is a popular test used to assess normality.  The null hypothesis is that the data are normally distributed. So the non-significant result ($p > 0.05$) indicates a normal distribution. It is not a powerful test when the sample size is small. Sometimes with large sample sizes it has a lot of power to detect even slight variations from normality. Usually, you can use $p=0.10$ as an indication of non-normal data along with visual inspection using histogram and Q-Q plot. Below we inspect the normality of each variable using the funciton `shapiro.test()`.
```{r}
smoker %>%
  select(-ID) %>%
  apply(2, shapiro.test)
```


Since the data are paired, we should be concerned with the normality of differences. If the data are normal, all the points should fall on a straight line in the Q-Q plot.
```{r}
ggplot(smoker, aes(sample=DIFF)) +
  geom_qq() +
  geom_qq_line(color='red') +
  ggtitle('Q-Q Plot') +
  xlab('Theoretical Distribution') +
  ylab('Sample Distribution')
```


# EDA
## Assessing Normality
Before we display boxplots, we just have to do a slight amount of data manipulation.
```{r}
boxplot_data = non_par_1 %>%
  stack() %>%
  filter(ind != 'ID')
```

So now, instead of our data looking like this...
```{r}
head(non_par_1)
```

...it looks like this.
```{r}
head(boxplot_data)
```

Now that we've manipulated our data to have `x` and `y` values for the `aes()` command, we can create our boxplots...
```{r}
ggplot(boxplot_data, aes(x=ind, y=values, fill=ind)) +
  geom_boxplot()
```



# Hypothesis Testing
## Wilcoxon Signed Rank Test
Since the Q-Q plot suggests that the data may not come from a normal distribution and the sample size is very small, let’s use the Wilcoxon signed rank test to determine whether CO transfer factor significantly changed over time (i.e. if `DIFF` is significantly different from $0$).

```{r}
wilcox.test(non_par_1$DIFF, mu=0)
```

# Hypothesis Testing
## Paired t-Test
Just out of curiosity, let's also performed a paired t-test and compare the results.
```{r}
t.test(non_par_1$DIFF, mu=0)
```

# Results

In both cases, the tests indicate that there is not sufficient evidence to support that CO transfer factor significantly changed over time among smokers with chicken pox.



# Non-Parametric Tests for Two Independent Samples

__Objective:__ 

__Packages:__ We will be using the `tidyverse` and `ggplot2` packages. If you have not yet installed them, please do so.
  
__Data\:__ Copy the `non_par_2.csv` dataset to a location of your choice.

```{r, message=FALSE, warning=FALSE}
non_par_2 = read_csv('./data/non_par_2.csv')
```

# EDA
Let’s first look at the data. Notice that the data are organized differently from the paired samples case. You have a group variable (CVI or control) and dependent variable (CD4+ T cell count).
```{r}
non_par_2
```

Let's be sure to convert `GROUP` to a factor before we move on, since it represents specific groups.
```{r}
non_par_2$GROUP = as.factor(non_par_2$GROUP)
```


Let us get familiar with our data by conducting a Shapiro-Wilk test, and looking at histograms and box plots.

We assess normality by conducting a Shapiro-Wilk test for each group.
```{r}
shapiro.test(non_par_2$CD4[non_par_2$GROUP == 1])
shapiro.test(non_par_2$CD4[non_par_2$GROUP == 2])
```


```{r}
ggplot(non_par_2, aes(x=CD4, fill=GROUP, color=GROUP)) +
  geom_histogram(bins=6, alpha=0.5, position="identity")
```


```{r}
ggplot(non_par_2, aes(x=GROUP, y=CD4, group=GROUP, fill=GROUP)) +
  geom_boxplot()
```

Even though the Shapiro-Wilk test is non-significant for each group, the boxplots and histograms appear to show that the data are positively skewed.  This is very typical of blood counts data.

Now let’s perform the Mann-Whitney test (Wilcoxon rank-sum test) to compare CD4 counts of two groups. 

```{r}
wilcox.test(non_par_2$CD4[non_par_2$GROUP == 1], non_par_2$CD4[non_par_2$GROUP == 2], correct=FALSE)
```

Let us also perform the Kruskal-Wallis test.
```{r}
kruskal.test(CD4 ~ GROUP, data=non_par_2)
```

Note that the p-value from the Kruskal-Wallis test is same as that from the Mann-Whitney (Wilcoxon rank-sum) test.



# Non-Parametric Tests for K Independent Samples

__Objective:__ “Torr et al. conducted a study to determine serum levels of nitrite in pediatric patients with human immunodeficiency virus type 1 (HIV-1) infection. Subjects included 10 healthy control children (6 boys and 4 girls) with a mean age of 9.7 years and a standard deviation of 3.3. The remainder of the subjects were 21 children born to HIV-1-infected mothers. Of these, seven (3 boys and 4 girls) were affected by AIDS. They had a mean age of 6 years old and a standard deviation of 2.8 years. The remaining 14 children (7 boys and 7 girls) became sero-negative for HIV-1 during the first year of life. Their mean age was 3.3 years with a standard deviation of 2.3 years. Among the data collected were the following serum levels of nitrite ($\mu mol/L$).”

__Packages:__ We will be using the `tidyverse` and `ggplot2` packages. If you have not yet installed them, please do so.
  
__Data\:__ Copy the `non_par_3.csv` dataset to a location of your choice.

```{r, message=FALSE, warning=FALSE}
non_par_3 = read_csv('./data/non_par_3.csv')
```


# EDA

```{r}
head(non_par_3)

non_par_3$GROUP = as.factor(non_par_3$GROUP)
```

Let us look at descriptive statistics, box plots, Q-Q plots and the Shapiro-Wilk test of normality.


```{r}
non_par_3 %>%
  group_by(GROUP) %>%
  summarise(n = n(),
            W = shapiro.test(NITRITE)$statistic,
            pvalue = shapiro.test(NITRITE)$p.value)
```

The Shapiro-Wilk test shows significant departure from normality in HIV-infected groups.

```{r}
ggplot(non_par_3, aes(x=GROUP, y=NITRITE, group=GROUP, fill=GROUP)) +
  geom_boxplot()
```

```{r}
ggplot(non_par_3, aes(sample=NITRITE, group=GROUP, color=GROUP)) +
  geom_qq() +
  geom_qq_line() +
  ggtitle('Q-Q Plot') +
  xlab('Theoretical Distribution') +
  ylab('Sample Distribution')
```


Let’s try the Kruskal-Wallis test.

```{r}
kruskal.test(NITRITE ~ GROUP, data=non_par_3)
```


The three groups differ significantly in nitrite levels. The HIV-infected groups (negative and positive) appear to be different from the control group. Let’s test if there is a significant difference between negative and positive groups.

```{r}
wilcox.test(non_par_3$NITRITE[non_par_3$GROUP == 'negative'], non_par_3$NITRITE[non_par_3$GROUP == 'positive'], correct=FALSE)
```

There is no difference in nitrite levels between the HIV positive and negative groups.



# Acknowledgements
This tutorial was adapted from [Amber Lin](https://ohsu-psu-sph.org/faculty-directory/name/amber-lin/)'s tutorials for PHPM 524: Introduction to Biostatistics at Oregon Health & Science University.

The template used for this tutorial is from
[Alison Presmanes-Hill](https://github.com/apreshill/data-vis-jamboree-ggplot)

